name: Test
permissions:
  contents: read
on:
  push:
    branches: [main, next]
    paths-ignore:
      - "**.md"
      - "**.txt"
      - "docs/**"
  pull_request:
    paths-ignore:
      - "**.md"
      - "**.txt"
      - "docs/**"

# Only latest commit (per PR) should run
concurrency:
  group: "${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}"
  cancel-in-progress: true

env:
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_CACHE_KEY: rust-cache-2026.02.18

jobs:
  test:
    name: Unit tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: rustup update --no-self-update
      - name: Add Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-release
          prefix-key: ${{ env.RUST_CACHE_KEY }}
          save-if: false
      - uses: taiki-e/install-action@v2
        with:
          tool: nextest@0.9.122
      - name: make - test
        run: make test

  doc-tests:
    name: Documentation tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-debug
          prefix-key: ${{ env.RUST_CACHE_KEY }}
          save-if: false
      - name: Install rust
        run: rustup update --no-self-update
      - name: Run doc-tests
        run: make test-docs

  test-react-sdk:
    name: React SDK tests
    runs-on: ubuntu-24.04
    needs: [build-web-client-dist-folder]
    steps:
      - uses: actions/checkout@v6
      - name: Fetch web client dist
        uses: actions/download-artifact@v4
        with:
          name: web-client-artifacts
          path: ./crates/web-client/dist
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: ./scripts/retry-yarn-install.sh packages/react-sdk
      - name: Run unit tests
        run: make test-react-sdk

  test-react-sdk-integration:
    name: React SDK integration tests
    runs-on: ubuntu-24.04
    needs: [build-web-client-dist-folder]
    steps:
      - uses: actions/checkout@v6
      - name: Fetch web client dist
        uses: actions/download-artifact@v4
        with:
          name: web-client-artifacts
          path: ./crates/web-client/dist
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: ./scripts/retry-yarn-install.sh packages/react-sdk
      - name: Install Playwright browsers
        run: cd ./packages/react-sdk && yarn playwright install --with-deps
      - name: Run Playwright tests
        run: cd ./packages/react-sdk && yarn test:integration

  build-react-sdk:
    name: Build React SDK
    runs-on: ubuntu-24.04
    needs: [ build-web-client-dist-folder ]
    steps:
      - uses: actions/checkout@v6
      - name: Fetch web client dist
        uses: actions/download-artifact@v4
        with:
          name: web-client-artifacts
          path: ./crates/web-client/dist
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: ./scripts/retry-yarn-install.sh packages/react-sdk
      - name: Build React SDK
        run: cd ./packages/react-sdk && yarn build

  build-node-builder:
    name: Build node-builder
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: rustup update --no-self-update
      - name: Restore node-builder binary
        id: cache-node-builder
        uses: actions/cache@v4
        with:
          path: target/release/testing-node-builder
          key: ${{ runner.os }}-node-builder-${{ hashFiles('Cargo.lock') }}
      - name: Build node-builder
        if: steps.cache-node-builder.outputs.cache-hit != 'true'
        run: cargo build --release --package node-builder --locked

  build-note-transport:
    name: Build note-transport
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: rustup update --no-self-update
      - name: Restore note-transport binary
        id: cache-note-transport
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/miden-note-transport-node-bin
          key: ${{ runner.os }}-note-transport-${{ hashFiles('Cargo.lock') }}
      - name: Install note-transport
        if: steps.cache-note-transport.outputs.cache-hit != 'true'
        run: cargo install --git https://github.com/0xMiden/miden-note-transport --locked

  integration-tests:
    name: Integration tests
    runs-on: ubuntu-24.04
    needs: [build-node-builder, build-note-transport]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: rustup update --no-self-update
      - uses: taiki-e/install-action@v2
        with:
          tool: nextest@0.9.122
      - name: Add Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-release
          prefix-key: ${{ env.RUST_CACHE_KEY }}
          save-if: false
      - name: Restore node-builder binary
        uses: actions/cache/restore@v4
        with:
          path: target/release/testing-node-builder
          key: ${{ runner.os }}-node-builder-${{ hashFiles('Cargo.lock') }}
      - name: Restore note-transport binary
        uses: actions/cache/restore@v4
        with:
          path: ~/.cargo/bin/miden-note-transport-node-bin
          key: ${{ runner.os }}-note-transport-${{ hashFiles('Cargo.lock') }}
      - name: Start test node
        run: |
          RUST_LOG=none target/release/testing-node-builder &
          sleep 4
          pgrep -f testing-node-builder || (echo "Failed to start node" && exit 1)
      - name: Start note transport
        run: |
          RUST_LOG=none miden-note-transport-node-bin &
          sleep 4
          pgrep -f miden-note-transport-node-bin || (echo "Failed to start note transport" && exit 1)
      - name: Run integration tests
        run: make integration-test-full
      - name: Stop test node
        if: always()
        run: make stop-node
      - name: Stop note transport
        if: always()
        run: make stop-note-transport

  build-web-client-dist-folder:
    name: Build Web Client
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust (needed for WASM build)
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown

      - name: Add Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-wasm
          prefix-key: ${{ env.RUST_CACHE_KEY }}
          save-if: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: ./scripts/retry-yarn-install.sh crates/web-client

      - name: Check TSC output equals commited JS
        run: |
          cd ./crates/idxdb-store/src/
          yarn
          yarn tsc --outDir ci_test_folder
          pushd ci_test_folder
          find . -type f ! -name "*.js" -delete
          popd
          diff -bur js ci_test_folder

      - name: Restore cache - dist folder
        id: dist-cache
        uses: actions/cache/restore@v4
        with:
          path: ./crates/web-client/dist
          key: ${{ runner.os }}-dist-${{ hashFiles('**/yarn.lock', './crates/web-client/src/**/*.ts', './crates/web-client/src/**/*.rs', 'Cargo.lock') }}
          restore-keys: ${{ runner.os }}-dist-

      - name: Build project
        if: steps.dist-cache.outputs.cache-hit != 'true'
        run: |
          cd ./crates/web-client
          MIDEN_WEB_DEV=true yarn run build

      - name: Save cache - dist folder
        if: steps.dist-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ./crates/web-client/dist
          key: ${{ steps.dist-cache.outputs.cache-key }}

      - name: Upload artifacts for matrix jobs
        uses: actions/upload-artifact@v4
        with:
          name: web-client-artifacts
          path: ./crates/web-client/dist

  integration-tests-web-client:
    name: Integration tests for web client
    runs-on: ubuntu-24.04
    needs: [build-web-client-dist-folder, build-node-builder]
    strategy:
      matrix:
        shard_index: [1, 2, 3, 4, 5, 6]
        shard_total: [6]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - name: Add Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-wasm
          prefix-key: ${{ env.RUST_CACHE_KEY }}
          save-if: false

      - name: Fetch dist folder
        uses: actions/download-artifact@v4
        with:
          name: web-client-artifacts
          path: ./crates/web-client/dist

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Configure setuid sandbox
        run: . ./scripts/configure-sandbox.sh
      - name: Restore node-builder binary
        uses: actions/cache/restore@v4
        with:
          path: target/release/testing-node-builder
          key: ${{ runner.os }}-node-builder-${{ hashFiles('Cargo.lock') }}
      - name: Start test node
        run: |
          RUST_LOG=none target/release/testing-node-builder &
          sleep 4
          pgrep -f testing-node-builder || (echo "Failed to start node" && exit 1)
      - name: Run web client tests
        run: |
          make integration-test-web-client
        env:
          SHARD_PARAMETER: "--shard=${{ matrix.shard_index }}/${{ matrix.shard_total }}"
      - name: Stop test node
        if: always()
        run: make stop-node

  integration-tests-remote-prover-web-client:
    name: Integration tests for remote prover
    runs-on: ubuntu-24.04
    needs: [build-web-client-dist-folder, build-node-builder]
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: |
          rustup update --no-self-update
          rustup target add wasm32-unknown-unknown
      - name: Add Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-wasm
          prefix-key: ${{ env.RUST_CACHE_KEY }}
          save-if: false
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch dist folder
        uses: actions/download-artifact@v4
        with:
          name: web-client-artifacts
          path: ./crates/web-client/dist

      - name: Configure setuid sandbox
        run: . ./scripts/configure-sandbox.sh
      - name: Restore node-builder binary
        uses: actions/cache/restore@v4
        with:
          path: target/release/testing-node-builder
          key: ${{ runner.os }}-node-builder-${{ hashFiles('Cargo.lock') }}
      - name: Restore prover binary
        id: cache-prover
        uses: actions/cache@v4
        with:
          path: target/release/testing-remote-prover
          key: ${{ runner.os }}-prover-${{ hashFiles('Cargo.lock') }}
      - name: Build prover
        if: steps.cache-prover.outputs.cache-hit != 'true'
        run: cargo build --release --package testing-remote-prover --locked
      - name: Start test node
        run: |
          RUST_LOG=none target/release/testing-node-builder &
          sleep 4
          pgrep -f testing-node-builder || (echo "Failed to start node" && exit 1)
      - name: Start prover
        run: |
          RUST_LOG=none target/release/testing-remote-prover &
          sleep 4
          pgrep -f testing-remote-prover || (echo "Failed to start prover" && exit 1)
      - name: Run remote prover tests
        run: make integration-test-remote-prover-web-client
      - name: Stop test node
        if: always()
        run: make stop-node
      - name: Stop miden-prover
        if: always()
        run: make stop-prover
