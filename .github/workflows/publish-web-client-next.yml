# This workflow publishes the web-client and react-sdk packages to npm if a patch release
# label is applied to the PR and the corresponding package.json version is bumped.

name: Publish Web Client SDK to NPM on Next

on:
  pull_request:
    branches:
      - next
    types:
      - closed

permissions:
  contents: read

jobs:
  publish:
    if: >
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'patch release')
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: next

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Set up Rust and wasm target
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          target: wasm32-unknown-unknown
          components: rust-src

      - name: Verify web-client version bump against next
        id: check_web_version
        run: ./scripts/check-web-client-version-pr.sh "${{ github.event.pull_request.base.sha }}"

      - name: Verify react-sdk version bump against next
        id: check_react_version
        run: ./scripts/check-react-sdk-version-pr.sh "${{ github.event.pull_request.base.sha }}"

      - name: Install & build web-client
        if: steps.check_web_version.outputs.should_publish == 'true' || steps.check_react_version.outputs.should_publish == 'true'
        run: |
          cd crates/web-client
          yarn install --frozen-lockfile
          yarn build

      - name: Publish to npm
        if: steps.check_web_version.outputs.should_publish == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_WEBCLIENT_TOKEN }}
        run: |
          cd crates/web-client
          npm publish --tag next

      - name: Install & build react-sdk
        if: steps.check_react_version.outputs.should_publish == 'true'
        run: |
          cd packages/react-sdk
          yarn install --frozen-lockfile
          yarn build

      - name: Publish react-sdk to npm
        if: steps.check_react_version.outputs.should_publish == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_WEBCLIENT_TOKEN }}
        run: |
          cd packages/react-sdk
          npm publish --tag next

      - name: Done
        if: steps.check_web_version.outputs.should_publish == 'true'
        env:
          CURRENT_VERSION: ${{ steps.check_web_version.outputs.current_version }}
        run: echo "✅ Web-client published version $CURRENT_VERSION."

      - name: Done (react-sdk)
        if: steps.check_react_version.outputs.should_publish == 'true'
        env:
          CURRENT_VERSION: ${{ steps.check_react_version.outputs.current_version }}
        run: echo "✅ React SDK published version $CURRENT_VERSION."

      - name: Skipped publish
        if: steps.check_web_version.outputs.should_publish != 'true'
        env:
          SHOULD_PUBLISH: ${{ steps.check_web_version.outputs.should_publish }}
          CURRENT_VERSION: ${{ steps.check_web_version.outputs.current_version }}
        run: |
          echo "ℹ️ Web-client publish skipped; should_publish=$SHOULD_PUBLISH"
          if [ -n "$CURRENT_VERSION" ]; then
            echo "Current version: $CURRENT_VERSION"
          fi

      - name: Skipped publish (react-sdk)
        if: steps.check_react_version.outputs.should_publish != 'true'
        env:
          SHOULD_PUBLISH: ${{ steps.check_react_version.outputs.should_publish }}
          CURRENT_VERSION: ${{ steps.check_react_version.outputs.current_version }}
        run: |
          echo "ℹ️ React SDK publish skipped; should_publish=$SHOULD_PUBLISH"
          if [ -n "$CURRENT_VERSION" ]; then
            echo "Current version: $CURRENT_VERSION"
          fi

